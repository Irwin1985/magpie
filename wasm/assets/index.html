<html>  
    <head>
        <title>Magpie playground</title>
        <meta charset="utf-8"/>
        <script src="wasm_exec.js"></script>

        <script>
            const go = new Go();
            WebAssembly.instantiateStreaming(fetch("magpie.wasm"), go.importObject).then((result) => {
                go.run(result.instance);
            });
        </script>

    </head>
    <body>
        <style type="text/css" media="screen">
            #editor { 
                width: 100%;
                height: 350px;
            }
            .magpie-error {
                position:absolute;
                background:rgba(100,200,100,0.5);
                z-index:20
            }
           </style>

<h3>Input</h3>
<div id="editor">let arr = [1,3,5,2,4,6,7,8,9]
println(arr)

for i in arr where i % 2 == 0 {
    println(i)
}

println("--------------------------------")
let arr1 = ["1","a5","5", "5b","4","cc", "7", "dd", "9"]
println(arr1)

for i in arr1 where /^\d+/.match(i) {
    println(i)
}</div>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.4.5/ace.js" type="text/javascript" charset="utf-8"></script>
        
        <script>
            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/solarized_light");
            editor.session.setMode("ace/mode/javascript");
            editor.getSession().setUseWorker(false);
            editor.setOptions({fontSize: "13pt"});
            editor.commands.addCommand({
                name: "run",
                bindKey: {win: "Ctrl-Enter", mac: "Command-Enter"},
                exec: function(editor) { interpret() }
            });
        </script>
        
        <p><button onclick="interpret();" id="interpretButton">Run code with Ctrl+Enter, or click HERE</button></p>
        <h3 id="output">Output</h3>
        <div style="width: 100%;">
            <textarea style="width: 100%;" id="result" name="result" rows="20"></textarea>
        </div>

    </body>
    <script>
        let interpret = function() {
            let editor = ace.edit("editor");

            //remove all markers previously added
            let all_markers = editor.session.getMarkers();
            for(var key in all_markers){
                if (all_markers[key].type == "fullLine") {
                    editor.session.removeMarker(all_markers[key].id);
                }
            }

            //evaluate code
            let code = editor.getValue();
            let { errline, output } = magpie_run_code(code)

            //check for parser error, and mark line if has error
            var Range = ace.require('ace/range').Range;
            if (errline > 0) { //parser error
                editor.session.addMarker(new Range(errline - 1, 0, errline - 1, 2000), "magpie-error", "fullLine");
            }

            //check for Runtime error, and mark line if has error
            let reg = /Runtime Error:.* at line (\d+)/g;
            var match;
            while (match = reg.exec(output)) {
                let line = parseInt(match[1]);
                editor.session.addMarker(new Range(line - 1, 0, line - 1, 2000), "magpie-error", "fullLine");
            }

            //output result
            result.value = output
        }
     </script>
</html> 

